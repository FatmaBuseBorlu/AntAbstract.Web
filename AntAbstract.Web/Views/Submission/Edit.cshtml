@using AntAbstract.Web.Models.ViewModels
@model SubmissionCreateViewModel

@{
    ViewData["Title"] = "Bildiri Düzenle";
    Layout = "_LayoutDashboard";
    var submissionId = ViewBag.SubmissionId;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold">Bildiri Düzenle</h4>
        <a href="/Submission/Index" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left"></i> Geri</a>
    </div>

    <div class="card dashboard-card border-0 shadow-sm p-4">
        <form asp-action="Edit" asp-route-id="@submissionId" enctype="multipart/form-data" method="post">

            <div class="mb-3">
                <label asp-for="Title" class="form-label fw-bold">Bildiri Başlığı</label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Sunum Türü</label>
                    <select asp-for="PresentationTypeId" class="form-select">
                        <option value="0">Sözlü Sunum</option>
                        <option value="1">Poster Sunum</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="Keywords" class="form-label fw-bold">Anahtar Kelimeler</label>
                    <input asp-for="Keywords" class="form-control" />
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="AbstractText" class="form-label fw-bold">Özet Metni</label>
                <textarea asp-for="AbstractText" class="form-control" rows="8"></textarea>
                <span asp-validation-for="AbstractText" class="text-danger"></span>
            </div>

            <hr class="my-4">

            <h5 class="fw-bold mb-3">Ortak Yazarlar</h5>
            <div id="author-list">
                @if (Model.Authors != null)
                {
                    for (int i = 0; i < Model.Authors.Count; i++)
                    {
                        <div class="row g-3 mb-3 p-3 rounded-3 border author-row bg-white shadow-sm">
                            <input type="hidden" name="Authors.Index" value="@i" />
                            <input type="hidden" name="Authors[@i].Order" value="@(i + 1)" />

                            <div class="col-md-3">
                                <label class="small text-muted">Adı</label>
                                <input name="Authors[@i].FirstName" value="@Model.Authors[i].FirstName" class="form-control form-control-sm" required />
                            </div>
                            <div class="col-md-3">
                                <label class="small text-muted">Soyadı</label>
                                <input name="Authors[@i].LastName" value="@Model.Authors[i].LastName" class="form-control form-control-sm" required />
                            </div>
                            <div class="col-md-4">
                                <label class="small text-muted">Kurum</label>
                                <input name="Authors[@i].Institution" value="@Model.Authors[i].Institution" class="form-control form-control-sm" required />
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-danger btn-sm w-100 remove-author-btn"><i class="fas fa-trash-alt"></i> Kaldır</button>
                            </div>

                            <div class="col-md-4">
                                <label class="small text-muted">E-Posta</label>
                                <input name="Authors[@i].Email" value="@Model.Authors[i].Email" class="form-control form-control-sm" />
                            </div>
                            <div class="col-md-4">
                                <label class="small text-muted">ORCID</label>
                                <input name="Authors[@i].ORCID" value="@Model.Authors[i].ORCID" class="form-control form-control-sm" />
                            </div>
                            <div class="col-md-4 d-flex align-items-center justify-content-end">
                                <div class="form-check mt-3">
                                    <input class="form-check-input" type="checkbox" name="Authors[@i].IsCorrespondingAuthor" value="true" @(Model.Authors[i].IsCorrespondingAuthor ? "checked" : "")>
                                    <label class="form-check-label small">Sorumlu Yazar?</label>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            <button type="button" class="btn btn-outline-primary btn-sm mb-4" id="add-author-btn"><i class="fas fa-plus"></i> Yazar Ekle</button>

            <hr class="my-4">

            <div class="mb-4">
                <label class="form-label fw-bold">Dosya Güncelle (Opsiyonel)</label>
                <input asp-for="SubmissionFile" type="file" class="form-control" />
                <small class="text-muted">Dosya yüklemezseniz eskisi geçerli kalır.</small>
            </div>

            <div class="text-end">
                <button type="submit" class="btn btn-success btn-lg px-5">KAYDET VE GÜNCELLE</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function () {
            let authorIndex = @(Model.Authors?.Count ?? 0);

            function getAuthorRowTemplate(index) {
                return `
                    <div class="row g-3 mb-3 p-3 rounded-3 border author-row bg-white shadow-sm">
                        <input type="hidden" name="Authors.Index" value="${index}" />
                        <div class="col-md-3"><input name="Authors[${index}].FirstName" class="form-control form-control-sm" placeholder="Adı" required /></div>
                        <div class="col-md-3"><input name="Authors[${index}].LastName" class="form-control form-control-sm" placeholder="Soyadı" required /></div>
                        <div class="col-md-4"><input name="Authors[${index}].Institution" class="form-control form-control-sm" placeholder="Kurum" required /></div>
                        <div class="col-md-2 d-flex align-items-end"><button type="button" class="btn btn-danger btn-sm w-100 remove-author-btn"><i class="fas fa-trash-alt"></i> Kaldır</button></div>
                        <div class="col-md-4"><input name="Authors[${index}].Email" class="form-control form-control-sm" placeholder="Email" /></div>
                        <div class="col-md-4"><input name="Authors[${index}].ORCID" class="form-control form-control-sm" placeholder="ORCID" /></div>
                    </div>
                `;
            }

            $('#add-author-btn').click(function() {
                $('#author-list').append(getAuthorRowTemplate(authorIndex));
                authorIndex++;
            });

            $(document).on('click', '.remove-author-btn', function () {
                $(this).closest('.author-row').remove();
            });
        });
    </script>
}