@using AntAbstract.Web.Models.ViewModels
@model SubmissionEditViewModel

@{
    ViewData["Title"] = "Bildiri Düzenle";
    Layout = "_LayoutDashboard";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1">Bildiri Düzenle</h4>
            <p class="text-muted small mb-0">Gönderilmiş bildiriniz üzerinde değişiklik yapın.</p>
        </div>
        <a href="/Submission/Index" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-1"></i> Geri Dön
        </a>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card dashboard-card border-0 shadow-sm">
                <div class="card-body p-4">

                    <form asp-action="Edit" enctype="multipart/form-data" method="post">
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="ConferenceId" />

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger shadow-sm mb-4" role="alert"></div>

                        <h5 class="fw-bold text-dark mb-3"><i class="fas fa-edit me-2 text-primary"></i> Çalışma Bilgileri</h5>

                        <div class="mb-4">
                            <label asp-for="Title" class="form-label fw-bold text-dark">Bildiri Başlığı</label>
                            <input asp-for="Title" class="form-control form-control-lg bg-light border-0" />
                            <span asp-validation-for="Title" class="text-danger small"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label class="form-label fw-bold text-dark">Sunum Türü</label>
                                <select asp-for="PresentationTypeId" class="form-select bg-light border-0">
                                    <option value="0">Sözlü Sunum</option>
                                    <option value="1">Poster Sunum</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-4">
                                <label asp-for="Keywords" class="form-label fw-bold text-dark">Anahtar Kelimeler</label>
                                <input asp-for="Keywords" class="form-control bg-light border-0" />
                                <span asp-validation-for="Keywords" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label asp-for="AbstractText" class="form-label fw-bold text-dark">Özet Metni</label>
                            <textarea asp-for="AbstractText" id="AbstractText" class="form-control bg-light border-0" rows="8"></textarea>
                            <span asp-validation-for="AbstractText" class="text-danger small"></span>
                        </div>

                        <hr class="my-5">

                        <h5 class="fw-bold text-dark mb-3"><i class="fas fa-users me-2 text-primary"></i> Ortak Yazarlar</h5>

                        <div id="author-list">
                            @if (Model.Authors != null)
                            {
                                for (int i = 0; i < Model.Authors.Count; i++)
                                {
                                    <div class="row g-3 mb-3 p-3 rounded-3 border author-row bg-white shadow-sm">
                                        <input type="hidden" name="Authors.Index" value="@i" />
                                        <input type="hidden" name="Authors[@i].Order" value="@(i + 1)" />

                                        <div class="col-md-3">
                                            <label class="small text-muted mb-1">Adı</label>
                                            <input name="Authors[@i].FirstName" value="@Model.Authors[i].FirstName" class="form-control form-control-sm" required />
                                        </div>
                                        <div class="col-md-3">
                                            <label class="small text-muted mb-1">Soyadı</label>
                                            <input name="Authors[@i].LastName" value="@Model.Authors[i].LastName" class="form-control form-control-sm" required />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="small text-muted mb-1">Kurum</label>
                                            <input name="Authors[@i].Institution" value="@Model.Authors[i].Institution" class="form-control form-control-sm" required />
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button type="button" class="btn btn-danger btn-sm w-100 remove-author-btn">
                                                <i class="fas fa-trash-alt me-1"></i> Sil
                                            </button>
                                        </div>

                                        <div class="col-md-4">
                                            <label class="small text-muted mb-1">E-Posta</label>
                                            <input name="Authors[@i].Email" value="@Model.Authors[i].Email" class="form-control form-control-sm" />
                                        </div>
                                        <div class="col-md-4">
                                            <label class="small text-muted mb-1">ORCID</label>
                                            <input name="Authors[@i].ORCID" value="@Model.Authors[i].ORCID" class="form-control form-control-sm" />
                                        </div>
                                        <div class="col-md-4 d-flex align-items-center justify-content-end">
                                            <div class="form-check mt-3">
                                                <input class="form-check-input" type="checkbox" name="Authors[@i].IsCorrespondingAuthor" value="true" @(Model.Authors[i].IsCorrespondingAuthor ? "checked" : "")>
                                                <label class="form-check-label small">Sorumlu Yazar</label>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                        </div>

                        <div class="mb-4">
                            <button type="button" class="btn btn-outline-primary btn-sm fw-bold" id="add-author-btn">
                                <i class="fas fa-plus me-1"></i> Yazar Ekle
                            </button>
                        </div>

                        <hr class="my-5">

                        <h5 class="fw-bold text-dark mb-3"><i class="fas fa-paperclip me-2 text-primary"></i> Dosya Güncelleme</h5>

                        <div class="mb-4">
                            @if (!string.IsNullOrEmpty(Model.ExistingFilePath))
                            {
                                <div class="alert alert-secondary d-flex align-items-center" role="alert">
                                    <i class="fas fa-file-pdf fa-2x me-3 text-danger"></i>
                                    <div>
                                        <strong>Mevcut Dosya Yüklü</strong><br>
                                        <small>Yeni bir dosya seçmezseniz mevcut dosya korunacaktır.</small>
                                    </div>
                                </div>
                            }

                            <label asp-for="SubmissionFile" class="form-label fw-bold text-dark">Yeni Dosya Seç (Opsiyonel)</label>
                            <input asp-for="SubmissionFile" type="file" class="form-control" accept=".pdf,.docx" />
                        </div>

                        <div class="text-end">
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-save me-2"></i> DEĞİŞİKLİKLERİ KAYDET
                            </button>
                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // Mevcut yazar sayısını alıyoruz ki index karışmasın
            let authorIndex = @(Model.Authors?.Count ?? 0);

            function getAuthorRowTemplate(index) {
                return `
                    <div class="row g-3 mb-3 p-3 rounded-3 border author-row bg-white shadow-sm">
                        <input type="hidden" name="Authors.Index" value="${index}" />
                        <input type="hidden" name="Authors[${index}].Order" value="${index + 1}" />

                        <div class="col-md-3">
                            <label class="small text-muted mb-1">Adı*</label>
                            <input name="Authors[${index}].FirstName" class="form-control form-control-sm" required />
                        </div>
                        <div class="col-md-3">
                            <label class="small text-muted mb-1">Soyadı*</label>
                            <input name="Authors[${index}].LastName" class="form-control form-control-sm" required />
                        </div>
                        <div class="col-md-4">
                            <label class="small text-muted mb-1">Kurum*</label>
                            <input name="Authors[${index}].Institution" class="form-control form-control-sm" required />
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-danger btn-sm w-100 remove-author-btn">Sil</button>
                        </div>
                        <div class="col-md-4">
                            <label class="small text-muted mb-1">E-Posta</label>
                            <input name="Authors[${index}].Email" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-4">
                            <label class="small text-muted mb-1">ORCID</label>
                            <input name="Authors[${index}].ORCID" class="form-control form-control-sm" />
                        </div>
                        <div class="col-md-4 d-flex align-items-center justify-content-end">
                             <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" name="Authors[${index}].IsCorrespondingAuthor" value="true">
                                <label class="form-check-label small">Sorumlu Yazar</label>
                            </div>
                        </div>
                    </div>`;
            }

            $('#add-author-btn').click(function() {
                $('#author-list').append(getAuthorRowTemplate(authorIndex));
                authorIndex++;
            });

            $(document).on('click', '.remove-author-btn', function () {
                $(this).closest('.author-row').remove();
            });
        });
    </script>
}